pipeline {
    agent any

    environment {
        K8S_NAMESPACE = 'sak-shetty'
        APP_NAME = 'springapp'
        DB_NAME = 'mysql-container'
        APP_IMAGE = 'sakit333/webapp_dev:latest'
        DB_IMAGE = 'mysql:8.0'
        APP_PORT = '8088'
        NODE_PORT = '30088'
        DB_PASSWORD = '1234'
        DB_NAME_MYSQL = 'myapplication'
        KUBE_PROJECT_DIR = 'k8s_prod_scripts'
        // Path to kubeconfig already placed on Jenkins server
        KUBECONFIG = '/home/jenkins/kubeconfig_for_jenkins/kubeconfig.yaml'
    }

    parameters {
        choice(
            name: 'ACTION', 
            choices: ['deploy', 'remove'], 
            description: 'Choose whether to deploy or remove resources'
        )
    }

    stages {

        stage('Verify Kubernetes Access') {
            steps {
                sh '''
                    echo "üîç Verifying access to Kubernetes cluster..."
                    kubectl --kubeconfig=$KUBECONFIG config view
                    kubectl --kubeconfig=$KUBECONFIG get nodes
                '''
            }
        }

        stage('Create Namespace') {
            when { expression { params.ACTION == 'deploy' } }
            steps {
                sh '''
                    echo "üì¶ Ensuring namespace exists..."
                    if ! kubectl --kubeconfig=$KUBECONFIG get namespace $K8S_NAMESPACE >/dev/null 2>&1; then
                        kubectl --kubeconfig=$KUBECONFIG apply -f $KUBE_PROJECT_DIR/namespace.yml
                        echo "‚úÖ Namespace created: $K8S_NAMESPACE"
                    else
                        echo "‚ÑπÔ∏è Namespace $K8S_NAMESPACE already exists. Skipping..."
                    fi
                '''
            }
        }

        stage('Deploy MySQL') {
            when { expression { params.ACTION == 'deploy' } }
            steps {
                sh '''
                    echo "üöÄ Deploying MySQL..."
                    kubectl --kubeconfig=$KUBECONFIG apply -f $KUBE_PROJECT_DIR/db_deploy_svc.yml -n $K8S_NAMESPACE
                '''
            }
        }

        stage('Wait for MySQL Ready') {
            when { expression { params.ACTION == 'deploy' } }
            steps {
                sh '''
                    echo "‚è≥ Waiting for MySQL pod to be ready..."
                    kubectl --kubeconfig=$KUBECONFIG wait --for=condition=ready pod -l app=mysql-container -n $K8S_NAMESPACE --timeout=180s
                '''
            }
        }

        stage('Deploy Spring Boot App') {
            when { expression { params.ACTION == 'deploy' } }
            steps {
                sh '''
                    echo "üöÄ Deploying Spring Boot App..."
                    kubectl --kubeconfig=$KUBECONFIG apply -f $KUBE_PROJECT_DIR/app_deploy_svc.yml -n $K8S_NAMESPACE
                '''
            }
        }

        stage('Show Resources After Deployment') {
            when { expression { params.ACTION == 'deploy' } }
            steps {
                sh '''
                    echo "üìä Showing resources after deployment..."
                    kubectl --kubeconfig=$KUBECONFIG get all -n $K8S_NAMESPACE
                '''
            }
        }

        stage('Remove Spring Boot App') {
            when { expression { params.ACTION == 'remove' } }
            steps {
                sh '''
                    echo "üßπ Removing Spring Boot app..."
                    kubectl --kubeconfig=$KUBECONFIG delete -f $KUBE_PROJECT_DIR/app_deploy_svc.yml -n $K8S_NAMESPACE || true
                '''
            }
        }

        stage('Remove MySQL') {
            when { expression { params.ACTION == 'remove' } }
            steps {
                sh '''
                    echo "üßπ Removing MySQL..."
                    kubectl --kubeconfig=$KUBECONFIG delete -f $KUBE_PROJECT_DIR/db_deploy_svc.yml -n $K8S_NAMESPACE || true
                '''
            }
        }

        stage('Remove Namespace') {
            when { expression { params.ACTION == 'remove' } }
            steps {
                sh '''
                    echo "üßπ Deleting namespace..."
                    kubectl --kubeconfig=$KUBECONFIG delete -f $KUBE_PROJECT_DIR/namespace.yml || true
                '''
            }
        }

        stage('Show Resources After Removal') {
            when { expression { params.ACTION == 'remove' } }
            steps {
                sh '''
                    echo "üìä Checking if namespace still exists..."
                    kubectl --kubeconfig=$KUBECONFIG get all -n $K8S_NAMESPACE || echo "‚úÖ Namespace deleted successfully."
                '''
            }
        }
    }

    post {
        always {
            echo "‚úÖ Jenkins Pipeline execution completed."
        }
    }
}
